# Compile linux kernel v2.6.28.10
Compile environment.

	OS:
	Linux fedora16.ie2 3.4.7-1.fc16.x86_64 #1 SMP Mon Jul 30 16:37:23 UTC 2012 x86_64 x86_64 x86_64 GNU/Linux

	gcc:
	gcc (GCC) 4.6.3 20120306 (Red Hat 4.6.3-2)
	Copyright (C) 2011 Free Software Foundation, Inc.
	This is free software; see the source for copying conditions.  There is NO
	warranty; not even for MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.

	make:
	GNU Make 3.82
	Built for x86_64-redhat-linux-gnu
	Copyright (C) 2010  Free Software Foundation, Inc.
	License GPLv3+: GNU GPL version 3 or later <http://gnu.org/licenses/gpl.html>
	This is free software: you are free to change and redistribute it.
	There is NO WARRANTY, to the extent permitted by law.

Compile procedure.

	To configure and build the kernel use:
	--------------------------------------
	cd /usr/src/linux-2.6.N
	make O=/home/name/build/kernel menuconfig
	make O=/home/name/build/kernel
	sudo make O=/home/name/build/kernel modules_install install

## make 版本不一致导致的问题
我是用的 make 版本相对比较新，所以会造成下面的错误：

	==$ make O=/home/kangyushi/work/makekernel/2.6.28.10/ver01/build/kernel menuconfig
	/home/kangyushi/work/makekernel/2.6.28.10/ver01/linux-2.6.28.10/Makefile:442: *** mixed implicit and normal rules.  Stop.
	make: *** [sub-make] Error 2

需要修正一下 **Makefile** 的一些语法错误。

	line - 442
	----------
	original
	--------
	config %config: scripts_basic outputmakefile FORCE
		$(Q)mkdir -p include/linux include/config
		$(Q)$(MAKE) $(build)=scripts/kconfig $@	
	-----------------------------------------------------------------------------------------------
	correction
	----------
	config: scripts_basic outputmakefile FORCE
		$(Q)mkdir -p include/linux include/config
		$(Q)$(MAKE) $(build)=scripts/kconfig $@


	%config: scripts_basic outputmakefile FORCE
		$(Q)mkdir -p include/linux include/config
		$(Q)$(MAKE) $(build)=scripts/kconfig $@
	

	line - 1610
	-----------
	original
	--------
	/ %/: prepare scripts FORCE
		$(cmd_crmodverdir)
		$(Q)$(MAKE) KBUILD_MODULES=$(if $(CONFIG_MODULES),1) \
		$(build)=$(build-dir)
	-----------------------------------------------------------------------------------------------
	correction
	----------
	/: prepare scripts FORCE
		$(cmd_crmodverdir)
		$(Q)$(MAKE) KBUILD_MODULES=$(if $(CONFIG_MODULES),1) \
		$(build)=$(build-dir)

	%/: prepare scripts FORCE
		$(cmd_crmodverdir)
		$(Q)$(MAKE) KBUILD_MODULES=$(if $(CONFIG_MODULES),1) \
		$(build)=$(build-dir)

## vdso error
gcc 4.6 不再支持 **linker-style** 架构，所以会报下面的错误。

	/home/kangyushi/work/makekernel/2.6.28.10/ver01/linux-2.6.28.10/arch/x86/include/asm/apic.h:103:11: warning: variable ‘msr2’ set but not used [-Wunused-but-set-variable]
	  VDSO    arch/x86/vdso/vdso.so.dbg
	gcc: error: elf_x86_64: No such file or directory
	make[2]: *** [arch/x86/vdso/vdso.so.dbg] Error 1
	make[1]: *** [arch/x86/vdso] Error 2
	make: *** [sub-make] Error 2
	
只需要按照如下规则替换即可：

	line - 28
	---------
	-m elf_x86_64 -> -m64
	---------------------
	original
	--------
	VDSO_LDFLAGS_vdso.lds = -m elf_x86_64 -Wl,-soname=linux-vdso.so.1 \
				-Wl,-z,max-page-size=4096 -Wl,-z,common-page-size=4096
	------------------------------------------------------------------------------
	correction
	----------
	VDSO_LDFLAGS_vdso.lds = -m64 -Wl,-soname=linux-vdso.so.1 \
				-Wl,-z,max-page-size=4096 -Wl,-z,common-page-size=4096
	
	------------------------------------------------------------------------------
	line - 72
	---------
	-m elf_x86 -> -m32
	-m elf_i386 -> -32
	------------------
	original
	--------
	VDSO_LDFLAGS_vdso32.lds = -m elf_i386 -Wl,-soname=linux-gate.so.1
	-----------------------------------------------------------------
	correction
	----------
	VDSO_LDFLAGS_vdso32.lds = -m32 -Wl,-soname=linux-gate.so.1

弄了半天，那 **vdso** 究竟指什么呢？

	VDSOs (Virtual Dynamically-linked Shared Objects) are a way to export kernel space routines to user space 
	applications, using standard mechanisms for linking and loading (i.e. standard ELF format).

VDSO 将内核态的调用映射到用户态的地址空间中，使得调用开销更小，路径更好。

 * [Linux 下的 VDSO](http://adam8157.info/blog/2011/10/linux-vdso)
 * [Linux内核特性之VDSO](http://blog.csdn.net/juana1/article/details/6904932) *
