# Compile linux kernel v2.6.28.10
这次编译将前面几次的实验理顺一下。

## Environment

	$ uname -a
	Linux bogon 2.6.26-2-686 #1 SMP Thu Nov 25 01:53:57 UTC 2010 i686 GNU/Linux

	$ gcc --version
	gcc (Debian 4.3.2-1.1) 4.3.2
	Copyright (C) 2008 Free Software Foundation, Inc.
	This is free software; see the source for copying conditions. There is NO
	warranty; not even for MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.

	$ make --version
	GNU Make 3.81
	Copyright (C) 2006 Free Software Foundation, Inc.
	This is free software; see the source for copying conditions.
	There is NO warranty; not even for MERCHANTABILITY or FITNESS FOR A
	PARTICULAR PURPOSE.

	This program built for i486-pc-linux-gnu

## make a snapshot

	# qemu-img -f qcow2 -b debian-508-original.img debian-508-snapshot.img

## start system

	# qemu-system-i386 -hda debian-508-snapshot.img -machine accel=kvm

## edit /etc/apt/sources.list
	
	# vim /etc/apt/sources.list
	deb http://mirrors.163.com/debian-archive lenny main contrib

	# apt-get update

## install build tools

	# apt-get install build-essential kernel-package libncurses5-dev

## configure the kernel

	# tar -jxvf linux-2.6.28.10.tar.bz2
	# cd linux-2.6.28.10

本此不再使用 `make menuconfig` 方式生成 `.config` 配置文件，而是用原系统内核编译时所使用的配置文件。这里我将编译好的文件指定存放到 `/home/debian/kernel/build/` 中（系统默认情况下，会将编译好的内容存放在内核源码目录中）。

	# cp /boot/config-2.6.26-2-686 /home/debian/kernel/build/.config

## compile the kernel

	# make 

## install modules & kernel

	# make O=/home/debian/kernel/build modules_install install

## update grub.cfg

	bogon:/boot# update-grub	<--- 此命令会自动更新 grub.cfg 文件，改程序会扫描 /boot 文件夹下与内核相关的文件。
	Updating /boot/grub/grub.cfg ...
	Found Debian background: moreblue-orbit-grub.png
	Found linux image: /boot/vmlinuz-2.6.28.10
	Found initrd image: /boot/initrd.img-2.6.28.10
	Found linux image: /boot/vmlinuz-2.6.26-2-686
	Found initrd image: /boot/initrd.img-2.6.26-2-686
	done
	bogon:/boot# cat grub/grub.cfg
	#
	# DO NOT EDIT THIS FILE
	#
	# It is automatically generated by /usr/sbin/update-grub using templates
	# from /etc/grub.d and settings from /etc/default/grub
	#

	### BEGIN /etc/grub.d/00_header ###
	set default=0
	set timeout=5
	set root=(hd0,1)
	search --fs-uuid --set d9dd743e-34e2-4915-8178-f357b11137af
	if font /usr/share/grub/ascii.pff ; then
	  set gfxmode=640x480
	  insmod gfxterm
	  insmod vbe
	  terminal gfxterm
	fi
	### END /etc/grub.d/00_header ###

	### BEGIN /etc/grub.d/05_debian_theme ###
	set root=(hd0,1)
	search --fs-uuid --set d9dd743e-34e2-4915-8178-f357b11137af
	insmod png
	if background_image /boot/grub/moreblue-orbit-grub.png ; then
	  set color_normal=black/black
	  set color_highlight=magenta/black
	else
	  set menu_color_normal=cyan/blue
	  set menu_color_highlight=white/blue
	fi
	### END /etc/grub.d/05_debian_theme ###

	### BEGIN /etc/grub.d/10_hurd ###
	### END /etc/grub.d/10_hurd ###

	### BEGIN /etc/grub.d/10_linux ###
	menuentry "Debian GNU/Linux, linux 2.6.28.10" {		<--- 程序执行完成后自动添加的内容
	set root=(hd0,1)
	search --fs-uuid --set d9dd743e-34e2-4915-8178-f357b11137af
	linux /boot/vmlinuz-2.6.28.10 root=UUID=d9dd743e-34e2-4915-8178-f357b11137af ro
	initrd /boot/initrd.img-2.6.28.10
	}
	menuentry "Debian GNU/Linux, linux 2.6.28.10 (single-user mode)" {	<--- 程序执行完成后自动添加的内容
	set root=(hd0,1)
	search --fs-uuid --set d9dd743e-34e2-4915-8178-f357b11137af
	linux /boot/vmlinuz-2.6.28.10 root=UUID=d9dd743e-34e2-4915-8178-f357b11137af ro single
	initrd /boot/initrd.img-2.6.28.10
	}
	menuentry "Debian GNU/Linux, linux 2.6.26-2-686" {
	set root=(hd0,1)
	search --fs-uuid --set d9dd743e-34e2-4915-8178-f357b11137af
	linux /boot/vmlinuz-2.6.26-2-686 root=UUID=d9dd743e-34e2-4915-8178-f357b11137af ro
	initrd /boot/initrd.img-2.6.26-2-686
	}
	menuentry "Debian GNU/Linux, linux 2.6.26-2-686 (single-user mode)" {
	set root=(hd0,1)
	search --fs-uuid --set d9dd743e-34e2-4915-8178-f357b11137af
	linux /boot/vmlinuz-2.6.26-2-686 root=UUID=d9dd743e-34e2-4915-8178-f357b11137af ro single
	initrd /boot/initrd.img-2.6.26-2-686
	}
	### END /etc/grub.d/10_linux ###

	### BEGIN /etc/grub.d/30_os-prober ###
	### END /etc/grub.d/30_os-prober ###

	### BEGIN /etc/grub.d/40_custom ###
	# This file is an example on how to add custom entries
	### END /etc/grub.d/40_custom ###

## reboot 
重启后选择所需要的版本即可。至于上一个版本中提到的 `initramfs` 版本的问题实际上对整个过程没有影响，问题的关键就在与 `config` 文件的配置上。


