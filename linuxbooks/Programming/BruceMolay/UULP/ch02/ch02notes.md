# 第 2 章 - 用户、文件操作与联机帮助：编写 who 命令

**概念与技巧**

 * 联机帮助的作用与使用方法
 * Unix 的文件操作函数：open、read、write、lseek、close
 * 文件的建立与读写
 * 文件描述符
 * 缓冲：用户级的缓冲与内核级的缓冲
 * 内核模式、用户模式和系统调用的代价
 * Unix 表示时间的方法与时间格式间的转换
 * 借助 utmp 文件来列出已登录的用户
 * 系统调用中的错误检测与处理

**相关的系统调用**

 * open、read、write、creat、lseek、close
 * perror

**相关命令**

 * man
 * who
 * cp
 * login

## 2.2 关于命令 who
本章的第一个程序通过对以下 3 个问题的解答来学习 who 命令：

 1. who 命令能做些什么？
 2. who 命令是如何工作的？
 3. 如何编写 who？

**命令也是程序**
在 Unix 系统中增加新的命令是一件很容易的事。把程序的可执行文件放到以下任意一个目录就可以了：

	/bin
	/usr/bin
	/usr/local/bin

## 2.3 问题 1 ：who 命令能做些什么

	==$ who
	zhou		tty1         2012-08-27 12:19 (:0)
	zhou 		pts/1        2012-08-31 10:19 (:0.0)
	kang		pts/2        2012-08-31 13:46 (kang-pc)
	kang		pts/4        2012-08-28 09:12 (:12.0)
	kang		pts/7        2012-08-28 10:07 (:12.0)
	kang		pts/8        2012-08-29 15:01 (:12.0)
	liu   		pts/3        2012-08-30 13:26 (:11.0)
	liu   		pts/11       2012-08-30 13:25 (:11.0)
	luru   		pts/13       2012-08-31 10:24 (:14.0)
	kang		pts/0        2012-08-31 13:44 (kang-pc)
	liru   		pts/10       2012-08-31 09:08 (:14.0)

每一行代表一个已经登录的用户，第 1 列是用户名，第 2 列是终端名，第 3 列是登录时间，第 4 列是用户的登录地址，某些版本的 who 命令在默认状态下不给出第 4 列的内容。

**阅读手册**
Unix 的联机帮助分为很多节。

	第 1 小节中是关于用户命令的帮助；
	第 2 小节中是关于系统调用的帮助；
	第 5 小节中是关于配置文件的帮助；

**who 命令的其他 3 种形式**

 * who am i
 * who am I
 * whoami

## 2.4 问题 2： who 命令是如何工作的
学习 Unix 系统编程的好处在于，最权威的资料，系统都已经提供过了。你只需要学会如何在 Unix 中获取这些资料的技巧即可。

**从 Unix 中学习 Unix**

以下 4 项技巧会有助于你的学习：

 * 阅读联机帮助
 * 搜索联机帮助
 * 阅读 .h 文件
 * 从参阅部分（SEE ALSO）得到启示

### 阅读联机帮助

	man who

### 搜索联机帮助

	man -k utmp
	man 4 utmp 
	
### 阅读 .h 文件
从 utmp 的联机帮助中可以知道，utmp 中的数据结构定义在 `/usr/include/utmp.h` 中。

	在 Unix 系统中，大多数的头文件都存放在 /usr/include 这个目录里，当 C 语言编译器在源程序中发现如下的定义：
	
	#include <stdio.h>

	它会到 /usr/include 中寻找相应的头文件。

最主要的是查看这里的 utmp 结构，查看过程中一定要注意被标记为

	兼容 - compatibility 

的行，这种行更可能出现平台差异。
